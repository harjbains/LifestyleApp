<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expense Quick Log</title>
  <style>
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    margin: 12px;
  }

  .card {
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 12px;
    max-width: 520px;
  }

  /* Flex rows */
  .row {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    flex-wrap: wrap;            /* allow wrapping */
  }

  /* Allow children to shrink (critical for iOS) */
  .row > div {
    flex: 1;
    min-width: 0;
  }

  label {
    display: block;
    font-size: 12px;
    opacity: .8;
    margin-bottom: 4px;
  }

  input, select, button {
    width: 100%;
    box-sizing: border-box;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
    font-size: 16px;
  }

  /* iOS date input fix */
  input[type="date"] {
    min-width: 0;
  }

  button { cursor: pointer; }

  .small { font-size: 12px; opacity: .8; }

  .list { margin-top: 12px; }

  .item {
    padding: 10px 0;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    gap: 10px;
  }

  .left { min-width: 0; }

  .desc {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 320px;
  }

  .amt { font-variant-numeric: tabular-nums; }

  .topline {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }

  /* Stack only the Date + Amount row on small screens */
  @media (max-width: 420px) {
    .row.stack-sm { flex-direction: column; }
  }

    /* Allow flex children to shrink properly on iOS */
.row > div { min-width: 0; }

/* Make Amount a fixed-width column like the Save token button */
.amt-col { flex: 0 0 140px; max-width: 160px; }

/* Date takes remaining width */
.date-col { flex: 1 1 auto; }

/* iOS date input sometimes refuses to shrink without this */
.date-col input[type="date"] { min-width: 0; width: 90%; }

.tabs { display:flex; gap:8px; margin-bottom:10px; }
.tab { flex:1; padding:10px; border-radius:10px; border:1px solid #ccc; background:#fff; }
.tab.active { font-weight:700; background:#f5f5f5; }
.tabPanel { display:none; }
.tabPanel.active { display:block; }

.summaryTop{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  margin-bottom:10px;
}
.summaryTitle{ font-weight:600; font-size:18px; }
.monthPick{ max-width: 220px; }

.cards{ display:flex; flex-direction:column; gap:10px; }

.card2{
  border:1px solid #eee; border-radius:12px; padding:12px;
  display:flex; flex-direction:column; gap:8px;
}
.row2{ display:flex; justify-content:space-between; gap:10px; align-items:baseline; }
.kpi{ font-weight:600; font-variant-numeric: tabular-nums; }
.muted{ opacity:.75; font-size:18px; }

.bar{
  height:10px; background:#eee; border-radius:999px; overflow:hidden;
}
.bar > div{ height:100%; width:0%; background:#111; border-radius:999px; }

.pill{
  font-size:16px; padding:4px 8px; border-radius:999px; border:1px solid #eeeeee;
  display:inline-block;
  background-color: rgb(186, 238, 238);
}

.totalsCard{
  margin-top:12px;
  border:1px solid #ddd; border-radius:12px; padding:12px;
}


</style>


</head>
<body>
  <div class="tabs">
  <button class="tab active" id="tabEntryBtn" type="button">Entry</button>
  <button class="tab" id="tabSummaryBtn" type="button">Summary</button>
</div>

<section id="tabEntry" class="tabPanel active">
  <div class="card">
    <div class="topline">
      <div>
        <div style="font-weight:700;">Quick Expense</div>
        
      </div>
      <select id="mode" title="List mode">
        <option value="today">Today</option>
        <option value="all" selected>All</option>
      </select>
    </div>

    <div class="row">
  <div>
    <label for="token">Token (saved on this device)</label>
    <input id="token" type="password" placeholder="Enter token once" />
  </div>
  <div style="max-width:160px;">
    <label>&nbsp;</label>
    <button id="saveTokenBtn" type="button">Save token</button>
  </div>
</div>

    <div class="row">
      <div class="date-col">
        <label for="date">Date</label>
        <input id="date" type="date" />
      </div>
     <div class="amt-col">
        <label for="amount">Amount (£)</label>
        <input id="amount" type="number" inputmode="decimal" step="0.01" placeholder="0.00" />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="category">Category</label>
        <select id="category">
          <option value="">Select…</option>
          <option>Grocery</option>
          <option>Transport</option>
          <option>Health</option>
          <option>Social</option>
          <option>Household</option>
          <option>Other</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="description">Description</label>
        <input id="description" type="text" placeholder="Asda, petrol, Amazon…" />
      </div>
    </div>

    <div class="row">
      <button id="addBtn">+ Add expense</button>
    </div>

    <div id="status" class="small"></div>

    <div class="list">
      <div style="font-weight:700; margin-top:10px;">Latest entries</div>
      <div id="items"></div>
    </div>
  </div>

</section>

<section id="tabSummary" class="tabPanel">
  <div class="summaryTop">
  <div class="summaryTitle">Summary</div>
  <select id="monthPick" class="monthPick"></select>
</div>

<div id="sumStatus" class="small"></div>

<div id="sumCards" class="cards"></div>

<div id="sumTotals" class="totalsCard"></div>
</section>
  <script>
    const $ = (id) => document.getElementById(id);
    // 1) Paste your Apps Script Web App URL here:
    //const API_URL = "https://script.google.com/macros/s/AKfycbxP_NiwGJPiex09bBCO23JX6h4SZWiHw_8fjpaFvrVyzcXX83OIWQ8rA_igHEJmjdBs/exec";

    const API_URL = "https://odd-wind-5e5a.harjbains.workers.dev/";

    const statusEl = $("status");
    const itemsEl = $("items");

   let TOKEN = localStorage.getItem("expense_token") || "";

function syncTokenUI() {
  const t = document.getElementById("token");
  if (t) t.value = TOKEN;
}

$("saveTokenBtn").addEventListener("click", () => {
  TOKEN = ($("token").value || "").trim();
  localStorage.setItem("expense_token", TOKEN);
  statusEl.textContent = TOKEN ? "Token saved ✔" : "Token cleared.";
  refresh();
});


   

    
    

    function setToday() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      $("date").value = `${yyyy}-${mm}-${dd}`;
    }

    function money(n) {
      const v = Number(n);
      if (!isFinite(v)) return "";
      return v.toLocaleString(undefined, { style: "currency", currency: "GBP" });
    }

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[c]));
    }

    async function refresh() {
      const mode = $("mode").value;
      statusEl.textContent = "Loading…";
      itemsEl.innerHTML = "";

      const url = `${API_URL}?action=list&mode=${encodeURIComponent(mode)}&token=${encodeURIComponent(TOKEN)}`;


      const res = await fetch(url, { method: "GET" });
      const json = await res.json();

      if (!json.ok) {
        statusEl.textContent = `Error: ${json.error || "Unknown"}`;
        return;
      }

      const data = json.data || [];
      statusEl.textContent = mode === "today"
        ? (data.length ? `Showing ${data.length} from today.` : "No entries yet today.")
        : (data.length ? `Showing latest ${data.length} entries.` : "No entries yet.");

      itemsEl.innerHTML = data.map(r => {
        const cat = escapeHtml(r.category || "");
        const desc = escapeHtml(r.description || "");
        const amt = money(r.amount);
        return `
          <div class="item">
            <div class="left">
              <div style="font-weight:600;">${cat || "—"}</div>
              <div class="small desc">${desc || "—"}</div>
            </div>
            <div class="amt" style="font-weight:700;">${amt}</div>
          </div>
        `;
      }).join("");
    }

    async function addExpense() {
      const date = $("date").value;
      const amount = $("amount").value;
      const category = $("category").value;
      const description = $("description").value;
      const mode = $("mode").value;

      if (!amount) { statusEl.textContent = "Enter an amount."; return; }

      $("addBtn").disabled = true;
      statusEl.textContent = "Saving…";

      const payload = { action: "add", token: TOKEN, date, amount, category, description, mode };



     const form = new URLSearchParams(payload);

const res = await fetch(API_URL, {
  method: "POST",
  headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
  body: form.toString()
});


      const json = await res.json();
      $("addBtn").disabled = false;

      if (!json.ok) {
        statusEl.textContent = `Error: ${json.error || "Unknown"}`;
        return;
      }

      // Clear minimal fields for speed
      $("amount").value = "";
      $("description").value = "";
      $("category").value = "";

      statusEl.textContent = "Saved ✔";
      await refresh();
    }

 $("addBtn").addEventListener("click", () => {
  $("status").textContent = "Button click detected ✅";
  addExpense();
});

    $("mode").addEventListener("change", refresh);

    setToday();
    syncTokenUI();

    refresh();

    function setTab(name) {
  $("tabEntryBtn").classList.toggle("active", name === "entry");
  $("tabSummaryBtn").classList.toggle("active", name === "summary");
  $("tabEntry").classList.toggle("active", name === "entry");
  $("tabSummary").classList.toggle("active", name === "summary");

  if (name === "summary") loadSummary();
}

$("tabEntryBtn").addEventListener("click", () => setTab("entry"));
$("tabSummaryBtn").addEventListener("click", () => setTab("summary"));


function parseMoney(val){
  // handles "£64.72", "0.00", "£0.00"
  const n = Number(String(val).replace(/[^0-9.\-]/g, ""));
  return isFinite(n) ? n : 0;
}
function fmtGBP(n){
  return Number(n).toLocaleString(undefined,{style:"currency",currency:"GBP"});
}

let summaryModel = null;

async function loadSummary() {
  const status = $("sumStatus");
  const cards = $("sumCards");
  const totals = $("sumTotals");
  const picker = $("monthPick");

  status.textContent = "Loading…";
  cards.innerHTML = "";
  totals.innerHTML = "";
  picker.innerHTML = "";

  const url = `${API_URL}?action=summary&token=${encodeURIComponent(TOKEN)}`;
  const res = await fetch(url);
  const text = await res.text();
  let json;
  try { json = JSON.parse(text); }
  catch { status.textContent = "Summary error (non-JSON)."; return; }

  if (!json.ok) { status.textContent = `Error: ${json.error || "Unknown"}`; return; }

  const rows = json.table || [];
  if (rows.length < 3) { status.textContent = "No summary data found."; return; }

  // Expect:
  // row0: headers: Month, Grocery, Transport, Health, Social, Buffer, Total
  // row1: Budget row
  // row2+: months
  const headers = rows[0].map(x => String(x).trim());
  const budgetRow = rows[1];
  const monthRows = rows.slice(2).filter(r => String(r[0]||"").trim());

  const categories = headers.slice(1, -1); // exclude Month and Total
  const budgets = {};
  categories.forEach((cat, i) => budgets[cat] = parseMoney(budgetRow[i+1]));

  const model = monthRows.map(r => {
    const month = String(r[0]).trim();
    const spent = {};
    categories.forEach((cat, i) => spent[cat] = parseMoney(r[i+1]));
    const total = parseMoney(r[headers.length-1]);
    return { month, spent, total };
  });

  summaryModel = { categories, budgets, months: model };

  // Populate picker
  model.forEach((m, idx) => {
    const opt = document.createElement("option");
    opt.value = String(idx);
    opt.textContent = m.month;
    picker.appendChild(opt);
  });

  // Default to first month row (your sheet likely has current month first)
  picker.value = "0";

  status.textContent = "";

  picker.onchange = () => renderSummaryForIndex(Number(picker.value));
  renderSummaryForIndex(0);
}

function renderSummaryForIndex(idx){
  const status = $("sumStatus");
  const cards = $("sumCards");
  const totals = $("sumTotals");

  if (!summaryModel) return;
  const { categories, budgets, months } = summaryModel;
  const m = months[idx];
  if (!m) { status.textContent = "Month not found."; return; }

  // Build category cards
  cards.innerHTML = categories.map(cat => {
    const b = budgets[cat] || 0;
    const s = m.spent[cat] || 0;
    const rem = b - s;
    const pct = b > 0 ? Math.max(0, Math.min(100, (s / b) * 100)) : 0;

    const pillText = rem >= 0 ? `${fmtGBP(rem)} left` : `${fmtGBP(-rem)} over`;
    const pill = `<span class="pill">${pillText}</span>`;

    return `
      <div class="card2">
        <div class="row2">
          <div style="font-weight:600;">${escapeHtml(cat)}</div>
          <div class="kpi">${fmtGBP(s)}</div>
        </div>
        <div class="row2">
          <div class="muted">Budget ${fmtGBP(b)}</div>
          ${pill}
        </div>
        <div class="bar"><div style="width:${pct}%;"></div></div>
      </div>
    `;
  }).join("");

  // Totals
  const budgetTotal = categories.reduce((acc,c)=>acc+(budgets[c]||0),0);
  const spentTotal = categories.reduce((acc,c)=>acc+(m.spent[c]||0),0);
  const remTotal = budgetTotal - spentTotal;

  totals.innerHTML = `
    <div style="font-weight:800; font-size:16px; margin-bottom:8px;">Totals — ${escapeHtml(m.month)}</div>
    <div class="row2"><div class="muted">Spent</div><div class="kpi">${fmtGBP(spentTotal)}</div></div>
    <div class="row2"><div class="muted">Budget</div><div class="kpi">${fmtGBP(budgetTotal)}</div></div>
    <div class="row2"><div class="muted">${remTotal>=0 ? "Remaining" : "Over"}</div><div class="kpi">${fmtGBP(Math.abs(remTotal))}</div></div>
  `;
}


const SUMMARY_SHEET = "Lifestyle";   // your actual tab name
const SUMMARY_RANGE = "A1:G20";

function getSummary_() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName(SUMMARY_SHEET);
  if (!sh) throw new Error(`Sheet "${SUMMARY_SHEET}" not found.`);
  return sh.getRange(SUMMARY_RANGE).getDisplayValues();
}

  </script>
</body>
</html>
