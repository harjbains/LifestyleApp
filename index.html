<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expense Quick Log</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; max-width: 520px; }
    .row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
    .row > div { flex: 1; min-width: 0; }
    label { display: block; font-size: 12px; opacity: .8; margin-bottom: 4px; }
    input, select, button { width: 100%; box-sizing: border-box; padding: 10px; border-radius: 10px; border: 1px solid #ccc; font-size: 16px; }
    input[type="date"] { min-width: 0; }
    button { cursor: pointer; }
    .small { font-size: 12px; opacity: .8; }
    .list { margin-top: 12px; }
    .item { padding: 10px 0; border-top: 1px solid #eee; display: flex; justify-content: space-between; gap: 10px; }
    .left { min-width: 0; }
    .desc { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 320px; }
    .amt { font-variant-numeric: tabular-nums; }
    .topline { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 8px; }
    @media (max-width: 420px) { .row.stack-sm { flex-direction: column; } }
    .amt-col { flex: 0 0 140px; max-width: 160px; }
    .date-col { flex: 1 1 auto; }
    .tabs { display:flex; gap:8px; margin-bottom:10px; }
    .tab { flex:1; padding:10px; border-radius:10px; border:1px solid #ccc; background:#fff; }
    .tab.active { font-weight:700; background:#f5f5f5; }
    .tabPanel { display:none; }
    .tabPanel.active { display:block; }
    .summaryTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .summaryTitle{ font-weight:600; font-size:18px; }
    .monthPick{ max-width: 220px; }
    .cards{ display:flex; flex-direction:column; gap:10px; }
    .card2{ border:1px solid #eee; border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:8px; cursor: pointer; }
    .row2{ display:flex; justify-content:space-between; gap:10px; align-items:baseline; }
    .kpi{ font-weight:600; font-variant-numeric: tabular-nums; }
    .muted{ opacity:.75; font-size:18px; }
    .bar{ height:10px; background:#eee; border-radius:999px; overflow:hidden; }
    .bar > div{ height:100%; width:0%; background:#111; border-radius:999px; }
    .pill{ font-size:16px; padding:4px 8px; border-radius:999px; border:1px solid #eeeeee; display:inline-block; background-color: rgb(186, 238, 238); }
    .totalsCard{ margin-top:12px; border:1px solid #ddd; border-radius:12px; padding:12px; }
    #detailList .item { border-top: 1px solid #eee; }
  </style>
</head>
<body>

<div class="tabs">
  <button class="tab active" id="tabEntryBtn">Entry</button>
  <button class="tab" id="tabSummaryBtn">Summary</button>
  <button class="tab" id="tabSettingsBtn">Settings</button>
</div>

<section id="tabEntry" class="tabPanel active">
  <div class="card">
    <div class="topline">
      <div style="font-weight:700;">Quick Expense 1978</div>
      <select id="mode">
        <option value="today">Today</option>
        <option value="all" selected>All</option>
      </select>
    </div>
    <div class="row">
      <div class="date-col">
        <label>Date</label>
        <input id="date" type="date" />
      </div>
      <div class="amt-col">
        <label>Amount (£)</label>
        <input id="amount" type="number" inputmode="decimal" step="0.01" placeholder="0.00" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Category</label>
        <select id="category"><option value="">Loading categories...</option></select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Description</label>
        <input id="description" type="text" placeholder="Asda, petrol, Amazon…" />
      </div>
    </div>
    <div class="row">
      <button id="addBtn">+ Add expense</button>
    </div>
    <div id="status" class="small"></div>
    <div class="list">
      <div style="font-weight:700; margin-top:10px;">Latest entries</div>
      <div id="items"></div>
    </div>
  </div>
</section>

<section id="tabSummary" class="tabPanel">
  <div class="summaryTop">
    <div class="summaryTitle">Summary</div>
    <select id="monthPick" class="monthPick"></select>
  </div>
  <div id="sumStatus" class="small"></div>
  <div id="sumCards" class="cards"></div>
  <div id="sumTotals" class="totalsCard"></div>
  <div id="detailTitle" style="font-weight:700; margin-top:12px;"></div>
  <div id="detailStatus" class="small"></div>
  <div id="detailList" class="list"></div>
</section>

<section id="tabSettings" class="tabPanel">
  <div class="card">
    <div style="font-weight:700; margin-bottom:10px;">Manage Categories & Budgets</div>
    <div class="row">
      <div>
        <label>Category Name</label>
        <input id="newCatName" type="text" placeholder="e.g. Rent">
      </div>
      <div>
        <label>Monthly Budget (£)</label>
        <input id="newCatAmount" type="number" placeholder="0.00">
      </div>
    </div>
    <button id="saveBudgetBtn">Save Category</button>
    <div id="budgetList" class="list"></div>
  </div>
</section>

<script>
  // 1. SELECTORS & CONSTANTS
  const $ = (id) => document.getElementById(id);
  const API_URL = "https://odd-wind-5e5a.harjbains.workers.dev/";
  const statusEl = $("status");
  const itemsEl = $("items");
  
  let USER_ID = null;
  let summaryModel = null;

  // 2. CLERK AUTHENTICATION SETUP
  const clerkPubKey = "pk_test_c2VjdXJlLXBsYXR5cHVzLTY0LmNsZXJrLmFjY291bnRzLmRldiQ";
  const script = document.createElement('script');
  script.setAttribute('data-clerk-publishable-key', clerkPubKey);
  script.async = true;
  // Note: Standard Clerk hostname used here
  script.src = `https://secure-platypus-64.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js`;

script.onload = async () => {
  // We use window.Clerk directly because it is already initialized by the script
  await window.Clerk.load({
    publishableKey: clerkPubKey
  });

  if (window.Clerk.user) {
    USER_ID = window.Clerk.user.id;
    
    // This mounts the profile icon/logout button automatically
    const userBtn = document.createElement('div');
    userBtn.id = "user-button";
    userBtn.style.marginLeft = "auto";
    document.querySelector('.tabs').appendChild(userBtn);
    window.Clerk.mountUserButton(userBtn);

    init(); 
  } else {
    // This forces the redirect to your home page specifically
    window.Clerk.openSignIn({
      afterSignInUrl: window.location.origin + window.location.pathname,
      afterSignUpUrl: window.location.origin + window.location.pathname
    });
  }
};
  document.head.appendChild(script);

  // 3. CORE API CALL (Verified with Clerk Token)
  async function apiCall(endpoint, options = {}) {
    const user = window.Clerk.user;
    if (!user) return { ok: false, error: "Not logged in" };

    const token = await window.Clerk.session.getToken();
    
    // Construct the full URL - Ensure 'endpoint' starts with a '?'
    const url = `https://odd-wind-5e5a.harjbains.workers.dev/${endpoint}`;

    const res = await fetch(url, {
        ...options,
        headers: {
            ...options.headers,
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    });

    if (!res.ok) throw new Error(`Server returned ${res.status}`);
    return res.json();
}

  // 4. APP LOGIC FUNCTIONS
  async function refresh() {
    statusEl.textContent = "Loading…";
    try {
      const json = await apiCall({ action: "list" });
      if (!json.ok) throw new Error(json.error);
      itemsEl.innerHTML = json.data.map(r => `
        <div class="item">
          <div class="left">
            <div style="font-weight:600;">${escapeHtml(r.category)}</div>
            <div class="small desc">${escapeHtml(r.description)}</div>
          </div>
          <div class="amt" style="font-weight:700;">${fmtGBP(r.amount)}</div>
        </div>
      `).join("");
      statusEl.textContent = "";
    } catch (e) { 
      statusEl.textContent = "Error loading list";
      console.error(e);
    }
  }

  async function addExpense() {
    const amount = $("amount").value;
    if (!amount) return alert("Enter an amount");
    $("addBtn").disabled = true;
    try {
      const json = await apiCall({ action: "add" }, {
        date: $("date").value,
        amount,
        category: $("category").value,
        description: $("description").value
      });
      if (json.ok) {
        $("amount").value = "";
        $("description").value = "";
        statusEl.textContent = "Saved ✔";
        refresh();
      }
    } catch (e) { alert("Save failed"); }
    $("addBtn").disabled = false;
  }

  async function refreshCategories() {
    const userId = window.Clerk.user.id;
    // Note: No curly braces around the endpoint string
    const data = await apiCall(`?action=get_budgets&user_id=${userId}`);
    
    if (data.ok) {
        const select = document.getElementById('categorySelect');
        select.innerHTML = '<option value="">Select Category</option>';
        data.data.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b.category;
            opt.textContent = b.category;
            select.appendChild(opt);
        });
    }
}

  async function loadSummary() {
    $("sumStatus").textContent = "Loading...";
    try {
      const json = await apiCall({ action: "summary" });
      if (!json.ok) throw new Error(json.error);
      
      summaryModel = json;
      const picker = $("monthPick");
      
      if (!json.months || json.months.length === 0) {
        $("sumStatus").textContent = "No data found.";
        $("sumCards").innerHTML = "";
        $("sumTotals").innerHTML = "";
        picker.innerHTML = "";
        return;
      }

      picker.innerHTML = json.months.map((m, i) => `<option value="${i}">${m.month}</option>`).join("");
      picker.onchange = () => renderSummaryForIndex(picker.value);
      
      renderSummaryForIndex(0);
      $("sumStatus").textContent = "";
    } catch (e) { 
      $("sumStatus").textContent = "Error: " + e.message; 
    }
  }

  function renderSummaryForIndex(idx) {
    if (!summaryModel || !summaryModel.months || !summaryModel.months[idx]) return;
    const m = summaryModel.months[idx];
    const budgets = summaryModel.budgets || {};
    const categories = summaryModel.categories || [];
    const monthKey = monthKeyFromLabel(m.month);

    $("sumCards").innerHTML = categories.map(cat => {
      const b = budgets[cat] || 0;
      const s = m.totals[cat] || 0;
      const pct = b > 0 ? Math.min(100, (s / b) * 100) : 0;
      return `
        <div class="card2">
          <div class="row2"><b>${escapeHtml(cat)}</b> <span>${fmtGBP(s)}</span></div>
          <div class="row2 small muted">Budget: ${fmtGBP(b)}</div>
          <div class="bar"><div style="width:${pct}%; background:${pct >= 100 ? '#ff4444' : '#111'}"></div></div>
        </div>`;
    }).join("");

    const totalSpent = Object.values(m.totals).reduce((a, b) => a + b, 0);
    $("sumTotals").innerHTML = `<b>Total Spent: ${fmtGBP(totalSpent)}</b>`;
  }

  // 5. HELPERS
  function setToday() {
    $("date").value = new Date().toISOString().split('T')[0];
  }

  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c]));
  }

  function fmtGBP(n){
    return Number(n).toLocaleString(undefined,{style:"currency",currency:"GBP"});
  }

  function monthKeyFromLabel(label){
    const parts = String(label).trim().split(/\s+/);
    if (parts.length < 2) return "";
    const map = { jan:"01", feb:"02", mar:"03", apr:"04", may:"05", jun:"06", jul:"07", aug:"08", sep:"09", oct:"10", nov:"11", dec:"12" };
    return `${parts[1]}-${map[parts[0].slice(0,3).toLowerCase()] || "01"}`;
  }

  function setTab(name) {
    ["Entry", "Summary", "Settings"].forEach(t => {
      $(`tab${t}Btn`).classList.toggle("active", name === t.toLowerCase());
      $(`tab${t}`).classList.toggle("active", name === t.toLowerCase());
    });
    if (name === "summary") loadSummary();
    if (name === "settings") refreshCategories();
  }

  // 6. INITIALIZATION & EVENTS
  function init() {
    setToday();
    refresh();
    refreshCategories();

    $("addBtn").onclick = addExpense;
    $("saveBudgetBtn").onclick = async () => {
      const category = $("newCatName").value.trim();
      const amount = $("newCatAmount").value;
      if (!category || !amount) return alert("Fill all fields");
      await apiCall({ action: "set_budget" }, { category, amount });
      $("newCatName").value = ""; $("newCatAmount").value = "";
      refreshCategories();
    };

    $("tabEntryBtn").onclick = () => setTab("entry");
    $("tabSummaryBtn").onclick = () => setTab("summary");
    $("tabSettingsBtn").onclick = () => setTab("settings");
  }
</script>
</body>
</html>
