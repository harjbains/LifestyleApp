<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" /> 
  <title>Expense Quick Log</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; max-width: 520px; }
    .row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
    .row > div { flex: 1; min-width: 0; }
    label { display: block; font-size: 12px; opacity: .8; margin-bottom: 4px; }
    input, select, button { width: 100%; box-sizing: border-box; padding: 10px; border-radius: 10px; border: 1px solid #ccc; font-size: 16px; }
    input[type="date"] { min-width: 0; }
    button { cursor: pointer; }
    .small { font-size: 12px; opacity: .8; }
    .list { margin-top: 12px; }
    .item { padding: 10px 0; border-top: 1px solid #eee; display: flex; justify-content: space-between; gap: 10px; }
    .left { min-width: 0; }
    .desc { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 320px; }
    .amt { font-variant-numeric: tabular-nums; }
    .topline { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 8px; }
    @media (max-width: 420px) { .row.stack-sm { flex-direction: column; } }
    .amt-col { flex: 0 0 140px; max-width: 160px; }
    .date-col { flex: 1 1 auto; }
    .tabs { display:flex; gap:8px; margin-bottom:10px; }
    .tab { flex:1; padding:10px; border-radius:10px; border:1px solid #ccc; background:#fff; }
    .tab.active { font-weight:700; background:#f5f5f5; }
    .tabPanel { display:none; }
    .tabPanel.active { display:block; }
    .summaryTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .summaryTitle{ font-weight:600; font-size:18px; }
    .monthPick{ max-width: 220px; }
    .cards{ display:flex; flex-direction:column; gap:10px; }
    .card2{ border:1px solid #eee; border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:8px; cursor: pointer; }
    .row2{ display:flex; justify-content:space-between; gap:10px; align-items:baseline; }
    .kpi{ font-weight:600; font-variant-numeric: tabular-nums; }
    .muted{ opacity:.75; font-size:18px; }
    .bar{ height:10px; background:#eee; border-radius:999px; overflow:hidden; }
    .bar > div{ height:100%; width:0%; background:#111; border-radius:999px; }
    .pill{ font-size:16px; padding:4px 8px; border-radius:999px; border:1px solid #eeeeee; display:inline-block; background-color: rgb(186, 238, 238); }
    .totalsCard{ margin-top:12px; border:1px solid #ddd; border-radius:12px; padding:12px; }
    #detailList .item { border-top: 1px solid #eee; }
  </style>
</head>
<body>

<div class="tabs">
  <button class="tab active" id="tabEntryBtn">Entry</button>
  <button class="tab" id="tabSummaryBtn">Summary</button>
  <button class="tab" id="tabSettingsBtn">Settings</button>
</div>

<section id="tabEntry" class="tabPanel active">
  <div class="card">
    <div class="topline">
      <div style="font-weight:700;">Quick Expense</div>
      <select id="mode">
        <option value="today">Today</option>
        <option value="all" selected>All</option>
      </select>
    </div>
    <div class="row">
      <div class="date-col">
        <label>Date</label>
        <input id="date" type="date" />
      </div>
      <div class="amt-col">
        <label>Amount (£)</label>
        <input id="amount" type="number" inputmode="decimal" step="0.01" placeholder="0.00" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Category</label>
        <select id="category"><option value="">Loading categories...</option></select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Description</label>
        <input id="description" type="text" placeholder="Asda, petrol, Amazon…" />
      </div>
    </div>
    <div class="row">
      <button id="addBtn">+ Add expense</button>
    </div>
    <div id="status" class="small"></div>
    <div class="list">
      <div style="font-weight:700; margin-top:10px;">Latest entries</div>
      <div id="items"></div>
    </div>
  </div>
</section>

<section id="tabSummary" class="tabPanel">
  <div class="summaryTop">
    <div class="summaryTitle">Summary</div>
    <select id="monthPick" class="monthPick"></select>
  </div>
  <div id="sumStatus" class="small"></div>
  <div id="sumCards" class="cards"></div>
  <div id="sumTotals" class="totalsCard"></div>
  <div id="detailTitle" style="font-weight:700; margin-top:12px;"></div>
  <div id="detailStatus" class="small"></div>
  <div id="detailList" class="list"></div>
</section>

<section id="tabSettings" class="tabPanel">
  <div class="card">
    <div style="font-weight:700; margin-bottom:10px;">Manage Categories & Budgets</div>
    <div class="row">
      <div>
        <label>Category Name</label>
        <input id="newCatName" type="text" placeholder="e.g. Rent">
      </div>
      <div>
        <label>Monthly Budget (£)</label>
        <input id="newCatAmount" type="number" placeholder="0.00">
      </div>
    </div>
    <button id="saveBudgetBtn">Save Category</button>
    <div id="budgetList" class="list"></div>
  </div>
</section>

<script>
  const $ = (id) => document.getElementById(id);
  const API_URL = "https://odd-wind-5e5a.harjbains.workers.dev/";
  const statusEl = $("status");
  const itemsEl = $("items");

  let USER_ID = localStorage.getItem("uid");
  if (!USER_ID) {
    USER_ID = crypto.randomUUID();
    localStorage.setItem("uid", USER_ID);
  }

  function setToday() {
    const d = new Date();
    $("date").value = d.toISOString().split('T')[0];
  }

  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c]));
  }

  function fmtGBP(n){
    return Number(n).toLocaleString(undefined,{style:"currency",currency:"GBP"});
  }

  function monthKeyFromLabel(label){
    const parts = String(label).trim().split(/\s+/);
    if (parts.length < 2) return "";
    const mStr = parts[0].slice(0,3).toLowerCase();
    const map = { jan:"01", feb:"02", mar:"03", apr:"04", may:"05", jun:"06", jul:"07", aug:"08", sep:"09", oct:"10", nov:"11", dec:"12" };
    return `${parts[1]}-${map[mStr] || "01"}`;
  }

  async function apiGet(params) {
    const url = new URL(API_URL);
    Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
    url.searchParams.set("user_id", USER_ID);
    const res = await fetch(url);
    return res.json();
  }

async function apiPost(params) {
  const body = new URLSearchParams();
  // Spread existing params + add user_id
  const fullParams = { ...params, user_id: USER_ID };
  
  for (const [key, value] of Object.entries(fullParams)) {
    body.append(key, value);
  }

  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: body.toString()
  });
  return res.json();
}

  // --- REFRESH DATA ---
  async function refresh() {
    statusEl.textContent = "Loading…";
    try {
      const json = await apiGet({ action: "list" });
      if (!json.ok) throw new Error(json.error);
      itemsEl.innerHTML = json.data.map(r => `
        <div class="item">
          <div class="left">
            <div style="font-weight:600;">${escapeHtml(r.category)}</div>
            <div class="small desc">${escapeHtml(r.description)}</div>
          </div>
          <div class="amt" style="font-weight:700;">${fmtGBP(r.amount)}</div>
        </div>
      `).join("");
      statusEl.textContent = "";
    } catch (e) { statusEl.textContent = "Error loading list"; }
  }

  async function addExpense() {
    const amount = $("amount").value;
    if (!amount) return alert("Enter an amount");
    $("addBtn").disabled = true;
    try {
      const json = await apiPost({
        action: "add",
        date: $("date").value,
        amount,
        category: $("category").value,
        description: $("description").value
      });
      if (json.ok) {
        $("amount").value = "";
        $("description").value = "";
        statusEl.textContent = "Saved ✔";
        refresh();
      }
    } catch (e) { alert("Save failed"); }
    $("addBtn").disabled = false;
  }

  // --- SETTINGS / CATEGORIES ---
  async function refreshCategories() {
    try {
      const json = await apiGet({ action: "get_budgets" });
      const cats = json.data || [];
      $("category").innerHTML = '<option value="">Select…</option>' + 
        cats.map(c => `<option value="${escapeHtml(c.category)}">${escapeHtml(c.category)}</option>`).join("");
      
      $("budgetList").innerHTML = cats.map(c => `
        <div class="item">
          <div class="left"><div style="font-weight:600;">${escapeHtml(c.category)}</div></div>
          <div class="amt" style="font-weight:700;">${fmtGBP(c.amount)}</div>
        </div>
      `).join("");
    } catch (e) { console.error(e); }
  }

  $("saveBudgetBtn").addEventListener("click", async () => {
    const category = $("newCatName").value.trim();
    const amount = $("newCatAmount").value;
    if (!category || !amount) return alert("Fill all fields");
    await apiPost({ action: "set_budget", category, amount });
    $("newCatName").value = ""; $("newCatAmount").value = "";
    refreshCategories();
  });

  // --- TABS ---
  function setTab(name) {
    ["Entry", "Summary", "Settings"].forEach(t => {
      $(`tab${t}Btn`).classList.toggle("active", name === t.toLowerCase());
      $(`tab${t}`).classList.toggle("active", name === t.toLowerCase());
    });
    if (name === "summary") loadSummary();
    if (name === "settings") refreshCategories();
  }

  $("tabEntryBtn").addEventListener("click", () => setTab("entry"));
  $("tabSummaryBtn").addEventListener("click", () => setTab("summary"));
  $("tabSettingsBtn").addEventListener("click", () => setTab("settings"));

  // --- SUMMARY ---
  let summaryModel = null;
  async function loadSummary() {
  $("sumStatus").textContent = "Loading...";
  try {
    const json = await apiGet({ action: "summary" });
    if (!json.ok) throw new Error(json.error);
    
    summaryModel = json;
    const picker = $("monthPick");
    
    if (!json.months || json.months.length === 0) {
      $("sumStatus").textContent = "No data found. Add some expenses first!";
      $("sumCards").innerHTML = "";
      $("sumTotals").innerHTML = "";
      picker.innerHTML = "";
      return;
    }

    picker.innerHTML = json.months.map((m, i) => `<option value="${i}">${m.month}</option>`).join("");
    picker.onchange = () => renderSummaryForIndex(picker.value);
    
    renderSummaryForIndex(0);
    $("sumStatus").textContent = "";
  } catch (e) { 
    $("sumStatus").textContent = "Error loading summary: " + e.message; 
  }
}

function renderSummaryForIndex(idx) {
  if (!summaryModel || !summaryModel.months || !summaryModel.months[idx]) return;

  const m = summaryModel.months[idx];
  const budgets = summaryModel.budgets || {};
  const categories = summaryModel.categories || []; // Safety fallback
  const monthKey = monthKeyFromLabel(m.month);

  if (categories.length === 0) {
    $("sumCards").innerHTML = "<p class='small'>No categories found. Add budgets in Settings!</p>";
    return;
  }

  $("sumCards").innerHTML = categories.map(cat => {
    const b = budgets[cat] || 0;
    const s = m.totals[cat] || 0;
    const pct = b > 0 ? Math.min(100, (s / b) * 100) : 0;
    return `
      <div class="card2" onclick="showCategoryDetails('${encodeURIComponent(cat)}','${encodeURIComponent(monthKey)}','${encodeURIComponent(m.month)}')">
        <div class="row2"><b>${escapeHtml(cat)}</b> <span>${fmtGBP(s)}</span></div>
        <div class="row2 small muted">Budget: ${fmtGBP(b)}</div>
        <div class="bar"><div style="width:${pct}%; background:${pct > 100 ? 'red' : '#111'}"></div></div>
      </div>`;
  }).join("");

  const totalSpent = Object.values(m.totals).reduce((a, b) => a + b, 0);
  $("sumTotals").innerHTML = `<b>Total Spent: ${fmtGBP(totalSpent)}</b>`;
}

  // --- INIT ---
  setToday();
  refresh();
  refreshCategories();
  $("addBtn").addEventListener("click", addExpense);
</script>
</body>
</html>
