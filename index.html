<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expense Quick Log</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; max-width: 520px; }
    .row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
    .row > div { flex: 1; min-width: 0; }
    label { display: block; font-size: 12px; opacity: .8; margin-bottom: 4px; }
    input, select, button { width: 100%; box-sizing: border-box; padding: 10px; border-radius: 10px; border: 1px solid #ccc; font-size: 16px; }
    input[type="date"] { min-width: 0; }
    button { cursor: pointer; }
    .small { font-size: 12px; opacity: .8; }
    .list { margin-top: 12px; }
    .item { padding: 10px 0; border-top: 1px solid #eee; display: flex; justify-content: space-between; gap: 10px; }
    .left { min-width: 0; }
    .desc { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 320px; }
    .amt { font-variant-numeric: tabular-nums; }
    .topline { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 8px; }
    @media (max-width: 420px) { .row.stack-sm { flex-direction: column; } }
    .amt-col { flex: 0 0 140px; max-width: 160px; }
    .date-col { flex: 1 1 auto; }
    .tabs { display:flex; gap:8px; margin-bottom:10px; }
    .tab { flex:1; padding:10px; border-radius:10px; border:1px solid #ccc; background:#fff; }
    .tab.active { font-weight:700; background:#f5f5f5; }
    .tabPanel { display:none; }
    .tabPanel.active { display:block; }
    .summaryTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .summaryTitle{ font-weight:600; font-size:18px; }
    .monthPick{ max-width: 220px; }
    .cards{ display:flex; flex-direction:column; gap:10px; }
    .card2{ border:1px solid #eee; border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:8px; cursor: pointer; }
    .row2{ display:flex; justify-content:space-between; gap:10px; align-items:baseline; }
    .kpi{ font-weight:600; font-variant-numeric: tabular-nums; }
    .muted{ opacity:.75; font-size:18px; }
    .bar{ height:10px; background:#eee; border-radius:999px; overflow:hidden; }
    .bar > div{ height:100%; width:0%; background:#111; border-radius:999px; }
    .pill{ font-size:16px; padding:4px 8px; border-radius:999px; border:1px solid #eeeeee; display:inline-block; background-color: rgb(186, 238, 238); }
    .totalsCard{ margin-top:12px; border:1px solid #ddd; border-radius:12px; padding:12px; }
    #detailList .item { border-top: 1px solid #eee; }
  </style>
</head>
<body>

<div class="tabs">
  <button class="tab active" id="tabEntryBtn">Entry</button>
  <button class="tab" id="tabSummaryBtn">Summary</button>
  <button class="tab" id="tabSettingsBtn">Settings</button>
</div>

<section id="tabEntry" class="tabPanel active">
  <div class="card">
    <div class="topline">
      <div style="font-weight:700;">Quick Expense 007</div>
      <select id="mode">
        <option value="today">Today</option>
        <option value="all" selected>All</option>
      </select>
    </div>
    <div class="row">
      <div class="date-col">
        <label>Date</label>
        <input id="date" type="date" />
      </div>
      <div class="amt-col">
        <label>Amount (£)</label>
        <input id="amount" type="number" inputmode="decimal" step="0.01" placeholder="0.00" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Category</label>
        <select id="category"><option value="">Loading categories...</option></select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Description</label>
        <input id="description" type="text" placeholder="Asda, petrol, Amazon…" />
      </div>
    </div>
    <div class="row">
      <button id="addBtn">+ Add expense</button>
    </div>
    <div id="status" class="small"></div>
    <div class="list">
      <div style="font-weight:700; margin-top:10px;">Latest entries</div>
      <div id="items"></div>
    </div>
  </div>
</section>

<section id="tabSummary" class="tabPanel">
  <div class="summaryTop">
    <div class="summaryTitle">Summary</div>
    <select id="monthPick" class="monthPick"></select>
  </div>
  <div id="sumStatus" class="small"></div>
  <div id="sumCards" class="cards"></div>
  <div id="sumTotals" class="totalsCard"></div>
  <div id="detailTitle" style="font-weight:700; margin-top:12px;"></div>
  <div id="detailStatus" class="small"></div>
  <div id="detailList" class="list"></div>
</section>

<section id="tabSettings" class="tabPanel">
  <div class="card">
    <div style="font-weight:700; margin-bottom:10px;">Manage Categories & Budgets</div>
    <div class="row">
      <div>
        <label>Category Name</label>
        <input id="newCatName" type="text" placeholder="e.g. Rent">
      </div>
      <div>
        <label>Monthly Budget (£)</label>
        <input id="newCatAmount" type="number" placeholder="0.00">
      </div>
    </div>
    <button id="saveBudgetBtn">Save Category</button>
    <div id="budgetList" class="list"></div>
  </div>
</section>

<script>
 const $ = (id) => document.getElementById(id);
  const API_URL = "https://odd-wind-5e5a.harjbains.workers.dev/";
  let summaryModel = null;

  // 1. CLERK AUTH
  const clerkPubKey = "pk_test_c2VjdXJlLXBsYXR5cHVzLTY0LmNsZXJrLmFjY291bnRzLmRldiQ";
  const script = document.createElement('script');
  script.setAttribute('data-clerk-publishable-key', clerkPubKey);
  script.async = true;
  script.src = `https://secure-platypus-64.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js`;
  script.onload = async () => {
    await window.Clerk.load();
    if (window.Clerk.user) {
      const userBtn = document.createElement('div');
      document.querySelector('.tabs').appendChild(userBtn);
      window.Clerk.mountUserButton(userBtn);
      init(); 
    } else {
      window.Clerk.openSignIn();
    }
  };
  document.head.appendChild(script);

  // 2. REPAIRED API CALL
  async function apiCall(action, params = {}, method = 'GET') {
    const user = window.Clerk.user;
    const token = await window.Clerk.session.getToken();
    
    // Always attach action and user_id to the URL
    const url = new URL(API_URL);
    url.searchParams.set("action", action);
    url.searchParams.set("user_id", user.id);

    const options = {
      method,
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
    };

    if (method === 'POST') options.body = JSON.stringify(params);

    const res = await fetch(url.toString(), options);
    return res.json();
  }

  // 3. LOGIC FUNCTIONS
  async function refresh() {
    $("status").textContent = "Loading…";
    try {
      const json = await apiCall("list");
      $("items").innerHTML = (json.data || []).map(r => `
        <div class="item">
          <div class="left">
            <div style="font-weight:600;">${escapeHtml(r.category)}</div>
            <div class="small desc">${escapeHtml(r.description)}</div>
          </div>
          <div class="amt" style="font-weight:700;">${fmtGBP(r.amount)}</div>
        </div>
      `).join("");
      $("status").textContent = "";
    } catch (e) { $("status").textContent = "Error loading list"; }
  }

  async function refreshCategories() {
    try {
      const data = await apiCall("get_budgets");
      const select = $("category"); // Matches HTML id="category"
      if (select && data.ok) {
        select.innerHTML = '<option value="">Select Category</option>' + 
          data.data.map(b => `<option value="${b.category}">${b.category}</option>`).join("");
      }
    } catch (err) { console.error(err); }
  }

  async function addExpense() {
    const amount = $("amount").value;
    if (!amount) return alert("Enter amount");
    $("addBtn").disabled = true;
    try {
      const res = await apiCall("add", {
        date: $("date").value,
        amount,
        category: $("category").value,
        description: $("description").value
      }, 'POST');
      if (res.ok) {
        $("amount").value = ""; $("description").value = "";
        refresh();
      }
    } catch (e) { alert("Save failed"); }
    $("addBtn").disabled = false;
  }

  // ... (Keep your summary/loadSummary/fmtGBP/init/setTab functions exactly as they are)
</script>
</body>
</html>
