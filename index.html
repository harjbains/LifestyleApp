<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expense Quick Log</title>
  <style>
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    margin: 12px;
  }

  .card {
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 12px;
    max-width: 520px;
  }

  /* Flex rows */
  .row {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    flex-wrap: wrap;            /* allow wrapping */
  }

  /* Allow children to shrink (critical for iOS) */
  .row > div {
    flex: 1;
    min-width: 0;
  }

  label {
    display: block;
    font-size: 12px;
    opacity: .8;
    margin-bottom: 4px;
  }

  input, select, button {
    width: 100%;
    box-sizing: border-box;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
    font-size: 16px;
  }

  /* iOS date input fix */
  input[type="date"] {
    min-width: 0;
  }

  button { cursor: pointer; }

  .small { font-size: 12px; opacity: .8; }

  .list { margin-top: 12px; }

  .item {
    padding: 10px 0;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    gap: 10px;
  }

  .left { min-width: 0; }

  .desc {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 320px;
  }

  .amt { font-variant-numeric: tabular-nums; }

  .topline {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }

  /* Stack only the Date + Amount row on small screens */
  @media (max-width: 420px) {
    .row.stack-sm { flex-direction: column; }
  }

    /* Allow flex children to shrink properly on iOS */
.row > div { min-width: 0; }

/* Make Amount a fixed-width column like the Save token button */
.amt-col { flex: 0 0 140px; max-width: 160px; }

/* Date takes remaining width */
.date-col { flex: 1 1 auto; }

/* iOS date input sometimes refuses to shrink without this */
.date-col input[type="date"] { min-width: 0; width: 90%; }

.tabs { display:flex; gap:8px; margin-bottom:10px; }
.tab { flex:1; padding:10px; border-radius:10px; border:1px solid #ccc; background:#fff; }
.tab.active { font-weight:700; background:#f5f5f5; }
.tabPanel { display:none; }
.tabPanel.active { display:block; }

.summaryBox {
  border:1px solid #eee;
  border-radius:10px;
  padding:10px;
}

.summaryTable {
  width:100%;
  border-collapse: collapse;
  font-size: 14px;
}

.summaryTable th,
.summaryTable td {
  border-bottom:1px solid #eee;
  padding:8px;
  text-align:right;
}

.summaryTable th:first-child,
.summaryTable td:first-child {
  text-align:left;
  font-weight:600;
}

</style>


</head>
<body>
  <div class="tabs">
  <button class="tab active" id="tabEntryBtn" type="button">Entry</button>
  <button class="tab" id="tabSummaryBtn" type="button">Summary</button>
</div>

<section id="tabEntry" class="tabPanel active">
  <div class="card">
    <div class="topline">
      <div>
        <div style="font-weight:700;">Quick Expense</div>
        
      </div>
      <select id="mode" title="List mode">
        <option value="today">Today</option>
        <option value="all" selected>All</option>
      </select>
    </div>

    <div class="row">
  <div>
    <label for="token">Token (saved on this device)</label>
    <input id="token" type="password" placeholder="Enter token once" />
  </div>
  <div style="max-width:160px;">
    <label>&nbsp;</label>
    <button id="saveTokenBtn" type="button">Save token</button>
  </div>
</div>

    <div class="row">
      <div class="date-col">
        <label for="date">Date</label>
        <input id="date" type="date" />
      </div>
     <div class="amt-col">
        <label for="amount">Amount (£)</label>
        <input id="amount" type="number" inputmode="decimal" step="0.01" placeholder="0.00" />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="category">Category</label>
        <select id="category">
          <option value="">Select…</option>
          <option>Grocery</option>
          <option>Transport</option>
          <option>Health</option>
          <option>Social</option>
          <option>Household</option>
          <option>Other</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="description">Description</label>
        <input id="description" type="text" placeholder="Asda, petrol, Amazon…" />
      </div>
    </div>

    <div class="row">
      <button id="addBtn">+ Add expense</button>
    </div>

    <div id="status" class="small"></div>

    <div class="list">
      <div style="font-weight:700; margin-top:10px;">Latest entries</div>
      <div id="items"></div>
    </div>
  </div>

</section>

<section id="tabSummary" class="tabPanel">
  <div style="font-weight:700; margin-bottom:8px;">Monthly Summary</div>
  <div class="small">This will show your budget vs actual.</div>

  <div class="summaryBox">
    <p><strong>Current month:</strong> Jan 2026</p>
    <p>Grocery: £64.72 / £300</p>
    <p>Transport: £93.25 / £200</p>
    <p>Health: £90.82 / £150</p>
    <p>Social: £113.55 / £50</p>
    <p>Buffer: £21.97 / £50</p>
    <p><strong>Total:</strong> £384.31 / £750</p>
  </div>
</section>
  <script>
    const $ = (id) => document.getElementById(id);
    // 1) Paste your Apps Script Web App URL here:
    const API_URL = "https://script.google.com/macros/s/AKfycbxP_NiwGJPiex09bBCO23JX6h4SZWiHw_8fjpaFvrVyzcXX83OIWQ8rA_igHEJmjdBs/exec";

    

    const statusEl = $("status");
    const itemsEl = $("items");

   let TOKEN = localStorage.getItem("expense_token") || "";

function syncTokenUI() {
  const t = document.getElementById("token");
  if (t) t.value = TOKEN;
}

$("saveTokenBtn").addEventListener("click", () => {
  TOKEN = ($("token").value || "").trim();
  localStorage.setItem("expense_token", TOKEN);
  statusEl.textContent = TOKEN ? "Token saved ✔" : "Token cleared.";
  refresh();
});


   

    
    

    function setToday() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      $("date").value = `${yyyy}-${mm}-${dd}`;
    }

    function money(n) {
      const v = Number(n);
      if (!isFinite(v)) return "";
      return v.toLocaleString(undefined, { style: "currency", currency: "GBP" });
    }

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[c]));
    }

    async function refresh() {
      const mode = $("mode").value;
      statusEl.textContent = "Loading…";
      itemsEl.innerHTML = "";

      const url = `${API_URL}?action=list&mode=${encodeURIComponent(mode)}&token=${encodeURIComponent(TOKEN)}`;


      const res = await fetch(url, { method: "GET" });
      const json = await res.json();

      if (!json.ok) {
        statusEl.textContent = `Error: ${json.error || "Unknown"}`;
        return;
      }

      const data = json.data || [];
      statusEl.textContent = mode === "today"
        ? (data.length ? `Showing ${data.length} from today.` : "No entries yet today.")
        : (data.length ? `Showing latest ${data.length} entries.` : "No entries yet.");

      itemsEl.innerHTML = data.map(r => {
        const cat = escapeHtml(r.category || "");
        const desc = escapeHtml(r.description || "");
        const amt = money(r.amount);
        return `
          <div class="item">
            <div class="left">
              <div style="font-weight:600;">${cat || "—"}</div>
              <div class="small desc">${desc || "—"}</div>
            </div>
            <div class="amt" style="font-weight:700;">${amt}</div>
          </div>
        `;
      }).join("");
    }

    async function addExpense() {
      const date = $("date").value;
      const amount = $("amount").value;
      const category = $("category").value;
      const description = $("description").value;
      const mode = $("mode").value;

      if (!amount) { statusEl.textContent = "Enter an amount."; return; }

      $("addBtn").disabled = true;
      statusEl.textContent = "Saving…";

      const payload = { action: "add", token: TOKEN, date, amount, category, description, mode };



     const form = new URLSearchParams(payload);

const res = await fetch(API_URL, {
  method: "POST",
  headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
  body: form.toString()
});


      const json = await res.json();
      $("addBtn").disabled = false;

      if (!json.ok) {
        statusEl.textContent = `Error: ${json.error || "Unknown"}`;
        return;
      }

      // Clear minimal fields for speed
      $("amount").value = "";
      $("description").value = "";
      $("category").value = "";

      statusEl.textContent = "Saved ✔";
      await refresh();
    }

 $("addBtn").addEventListener("click", () => {
  $("status").textContent = "Button click detected ✅";
  addExpense();
});

    $("mode").addEventListener("change", refresh);

    setToday();
    syncTokenUI();

    refresh();

    function setTab(name) {
  $("tabEntryBtn").classList.toggle("active", name === "entry");
  $("tabSummaryBtn").classList.toggle("active", name === "summary");
  $("tabEntry").classList.toggle("active", name === "entry");
  $("tabSummary").classList.toggle("active", name === "summary");

  if (name === "summary") loadSummary();
}

$("tabEntryBtn").addEventListener("click", () => setTab("entry"));
$("tabSummaryBtn").addEventListener("click", () => setTab("summary"));


async function loadSummary() {
  const box = document.querySelector(".summaryBox");
  box.innerHTML = "Loading…";

  const url = `${API_URL}?action=summary&token=${encodeURIComponent(TOKEN)}`;
  const res = await fetch(url);
  const json = await res.json();

  if (!json.ok) {
    box.textContent = `Error: ${json.error || "Unknown"}`;
    return;
  }

  const rows = json.table || [];
  const head = rows[0];
  const body = rows.slice(1);

  box.innerHTML =
    `<table class="summaryTable">
      <thead><tr>${head.map(h => `<th>${h}</th>`).join("")}</tr></thead>
      <tbody>
        ${body.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join("")}</tr>`).join("")}
      </tbody>
     </table>`;
}

const SUMMARY_SHEET = "Lifestyle";   // your actual tab name
const SUMMARY_RANGE = "A1:G20";

function getSummary_() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName(SUMMARY_SHEET);
  if (!sh) throw new Error(`Sheet "${SUMMARY_SHEET}" not found.`);
  return sh.getRange(SUMMARY_RANGE).getDisplayValues();
}

  </script>
</body>
</html>
